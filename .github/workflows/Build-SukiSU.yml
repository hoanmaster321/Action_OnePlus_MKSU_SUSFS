name: Build OnePlus_SukiSU Ultra All

on:
  workflow_dispatch:
    inputs:
      CPU:
        type: choice
        description: "Ná»n táº£ng SoC (nhÃ¡nh OnePlus)"
        required: true
        default: sm8550
        options:
          - sm7550
          - sm7675
          - sm8450
          - sm8475
          - sm8550
          - sm8650
          - sm8750
          - sm8850

      FEIL:
        type: choice
        description: "File cáº¥u hÃ¬nh thiáº¿t bá»‹ (manifest xml)"
        required: true
        default: oneplus_ace2_pro_v
        options:
          - oneplus_nord_ce4_v
          - oneplus_ace_3v_v
          - oneplus_nord_4_v
          - oneplus_10_pro_v
          - oneplus_10t_v
          - oneplus_11r_v
          - oneplus_ace2_v
          - oneplus_ace_pro_v
          - oneplus_11_v
          - oneplus_12r_v
          - oneplus_ace2_pro_v
          - oneplus_ace3_v
          - oneplus_open_v
          - oneplus12_v
          - oneplus_13r
          - oneplus_ace3_pro_v
          - oneplus_ace5
          - oneplus_pad2_v
          - oneplus_13
          - oneplus_13t
          - oneplus_ace5_pro
          - oneplus_pad_2_pro
          - oneplus_pad_3
          - oneplus_15
          - GitHubæœ‰bugå¯èƒ½ä¸æ˜¾ç¤ºæœ€åŽä¸€é¡¹,è¯¯ä½¿ç”¨æ­¤é¡¹

      CPUD:
        type: choice
        description: "TÃªn mÃ£ SoC (dÃ¹ng khi build kernel)"
        required: true
        default: kalama
        options:
          - crow
          - waipio
          - kalama
          - pineapple
          - sun
          - canoe

      ANDROID_VERSION:
        type: choice
        description: "PhiÃªn báº£n Android cá»§a kernel"
        required: true
        default: android15
        options:
          - android12
          - android13
          - android14
          - android15
          - android16

      KERNEL_VERSION:
        type: choice
        description: "PhiÃªn báº£n kernel"
        required: true
        default: "5.15"
        options:
          - "5.10"
          - "5.15"
          - "6.1"
          - "6.6"
          - "6.12"

      BUILD_METHOD:
        type: choice
        description: "CÃ¡ch build kernel"
        required: true
        default: gki
        options:
          - gki
          - perf

      SUSFS_CI:
        type: boolean
        description: "Táº£i module SUSFS tá»« CI?"
        required: true
        default: true

      VFS:
        type: boolean
        description: "Báº­t hook VFS?"
        required: true
        default: true

      KPM:
        type: boolean
        description: "Báº­t KPM?"
        required: true
        default: true

      ZRAM:
        type: boolean
        description: "Báº­t thÃªm thuáº­t toÃ¡n ZRAM (LZ4KD)?"
        required: true
        default: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ============================================================
      # Tá»I Æ¯U DUNG LÆ¯á»¢NG MÃY BUILD
      # ============================================================
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      # ============================================================
      # Cáº¤U HÃŒNH GIT
      # ============================================================
      - name: Configure Git
        run: |
          git config --global user.name "Numbersf"
          git config --global user.email "263623064@qq.com"

      # ============================================================
      # CÃ€I DEPENDENCY CÆ  Báº¢N
      # ============================================================
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 git curl jq

      # ============================================================
      # HIá»‚N THá»Š INPUT Äá»‚ DEBUG
      # ============================================================
      - name: Show selected inputs
        run: |
          echo "CPU=${{ github.event.inputs.CPU }}"
          echo "FEIL=${{ github.event.inputs.FEIL }}"
          echo "CPUD=${{ github.event.inputs.CPUD }}"
          echo "ANDROID=${{ github.event.inputs.ANDROID_VERSION }}"
          echo "KERNEL=${{ github.event.inputs.KERNEL_VERSION }}"
          echo "BUILD=${{ github.event.inputs.BUILD_METHOD }}"
          echo "SUSFS_CI=${{ github.event.inputs.SUSFS_CI }}"
          echo "ZRAM=${{ github.event.inputs.ZRAM }}"
          echo "VFS=${{ github.event.inputs.VFS }}"
          echo "KPM=${{ github.event.inputs.KPM }}"

      # ============================================================
      # CÃ€I REPO TOOL
      # ============================================================
      - name: Install repo tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod +x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      # ============================================================
      # INIT REPO
      # ============================================================
      - name: Repo init
        run: |
          mkdir kernel_workspace
          cd kernel_workspace
          repo init \
            -u https://github.com/OnePlusOSS/kernel_manifest.git \
            -b oneplus/${{ github.event.inputs.CPU }} \
            -m ${{ github.event.inputs.FEIL }}.xml \
            --depth=1

      # ============================================================
      # ðŸ”¥ FIX Lá»–I MANIFEST (QUAN TRá»ŒNG NHáº¤T)
      # Sá»¬A CÃC BRANCH ÄÃƒ Bá»Š QUALCOMM XOÃ
      # ============================================================
      - name: Fix dead kernel branches in manifest (VIETNAMESE FIX)
        run: |
          cd kernel_workspace/.repo/manifests

          case "${{ github.event.inputs.KERNEL_VERSION }}" in
            "5.10") BRANCH="ks-kernel.lnx.5.10" ;;
            "5.15") BRANCH="android13-5.15" ;;
            "6.1")  BRANCH="android14-6.1" ;;
            "6.6")  BRANCH="android15-6.6" ;;
            *)      BRANCH="master" ;;
          esac

          echo ">> Sá»­ dá»¥ng branch kernel: $BRANCH"

          sed -i \
            -e 's/ks-kernel.lnx.5.0.r3-rel/'"$BRANCH"'/g' \
            -e 's/ks-kernel.lnx.5.0.r3/'"$BRANCH"'/g' \
            -e 's/ks-kernel.lnx.5.0/'"$BRANCH"'/g' \
            *.xml

      # ============================================================
      # SYNC SOURCE
      # ============================================================
      - name: Repo sync
        run: |
          cd kernel_workspace
          repo sync -j1 --fail-fast
